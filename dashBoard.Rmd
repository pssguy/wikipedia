---
title: "Wikipedia Pageviews (under development)"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    css: styles.css
    source_code: embed
    social: ["twitter", "facebook", "google-plus","linkedin", "pinterest"]
runtime: shiny    
---

```{r setup, warning= FALSE ,message = FALSE}

library(flexdashboard)
#library(shiny)
library(pageviews)
library(DT)
library(plotly)
library(stringr)
library(GuardianR)
library(httr)
library(rvest)
library(XML)
library(selectr)
library(feather)
library(tidyverse)

# pageViewsEn <- read_csv("data/pageViewsEn.csv") %>% 
#   data.frame()#  has attr otherwise

# fast and no ascii issues cf readr
pageViewsEn <- read_feather("pageViewsEn.feather")

exclude <- c("Main_Page","404.php", "Special:Search")
todayTopTen <-pageViewsEn %>% 
  mutate(date <- as.Date(date)) %>% ## if not using readr 
  filter(date==max(date)&!article %in% exclude) %>% 
  select(article,views) %>% 
  mutate(rank=min_rank(-views)) %>% 
  head(10)

```


Home
===================================== 


Column {data-width=650}
-----------------------------------------------------------------------

### Compare one or more Wikipedia pages from mid 2015 to date. Stick to one for Guardian links and Wiki sidebar

```{r carpenrty, warning= FALSE ,message = FALSE}

# Input
textInput(inputId="articles",label="Start words with capital letter. Check wiki page for exact input, if required",placeholder = "e.g. George Michael,Glenn Frey")

# Only action when list complete
actionButton(inputId="go",label="Go")


data <- eventReactive(input$go,{

  # manipulate input as required for pageviews function
  vals <- str_trim(unlist(str_split(input$articles,",")))
  today <- paste0(str_replace_all(Sys.Date(),"-",""),"00")
 
  # Actual start date is from mid 2015
comp_pageviews <- article_pageviews(article = vals,
                                     start = "2015010100", end = today)
info=list(df=comp_pageviews,vals=vals)

   } )

```



```{r table, warning= FALSE ,message = FALSE}

# tabular output
output$wikitable <- DT::renderDataTable({
  req(data)
 
data()$df %>%
  group_by(article) %>%
  summarise(tot=sum(views),max=max(views),min=min(views),median=round(median(views),0),toppc=round(100*max/tot),maxdate=as.Date(date[which(views==max(views))]))%>%
  arrange(desc(median)) %>%
                         DT::datatable(class='compact stripe hover row-border order-column',rownames=FALSE,options= list(paging = FALSE, searching = FALSE,info=FALSE))
})

DT::dataTableOutput("wikitable")

```

### Daily hits on English version. Zoom as required. Click date for Guardian articles

```{r chart, warning= FALSE ,message = FALSE}
output$wikiplot <- renderPlotly({
  
   req(data)
  
data()$df %>% 
  plot_ly(x=~date, y=~log10(views), color=~article) %>% 
  add_lines(showlegend=FALSE) %>% 
  add_markers( text=~paste0("Views: ",views), key= ~article) %>% 
  layout(
    title="Daily Views of article(s) on English Wikipedia<br> (Hover for details)",
    xaxis=list(title=""),
    yaxis=list(title="Views (log10)")
  ) 
})
  plotlyOutput("wikiplot")

```


Column {data-width=350}
-----------------------------------------------------------------------

### Guardian Articles (Most Popular wiki selection only)

```{r articles, warning= FALSE ,message = FALSE}

# Needs more development
 output$guardianTable <- DT::renderDataTable({
   req(event_data("plotly_click"))
       d <- event_data("plotly_click")
     
    if (is.null(d)) {
      return()
    } else  {
  theDate <- d[["x"]]
 
  cN <- d[["curveNumber"]] # currently not utilized
  
    }
   

 
betterName <- str_trim(str_split(data()$vals[cN],"[(]")[[1]][1])  # caters for those wher has say more than 1


theName <- str_replace_all(betterName," ","+")
 #  encapsulate for exact name - otherwise will include undesired links
  theName <- paste0("%22",theName,"%22")
 

results <- get_guardian(
  theName,
  from.date = theDate,
  to.date = theDate,
  
  api.key = "3xzg2fk53jcdgaj5tbwqqhcz" # from vignette seems to work
)

link <- character()
  blankdf <- data.frame(link)
  
  ## work still required
if (nrow(results) == 1 | is.na(results$id[1])) {
  DT::datatable(
    blankdf,rownames = FALSE,escape = FALSE,options = list(
      paging = FALSE, searching = FALSE,info = FALSE
    )
  )
} else {
  results %>%
    mutate(link = paste0(
      "<a href=\"",webUrl,"\" target=\"_blank\">", webTitle,"</a>"
    )) %>%
    select(link) %>%
    DT::datatable(
      rownames = FALSE,escape = FALSE,options = list(
        paging = TRUE, searching = FALSE,info = FALSE, pageLength = 5
      )
    )
}



  
   
 })

DT::dataTableOutput("guardianTable")
```


### Wikipedia Sidebar (first name entered) Links inoperable

```{r }


output$wikiCard <- renderUI({
  req(data())
  
  theName <- str_replace_all(data()$vals[1]," ","_")
  url <- paste0("http://en.wikipedia.org/wiki/",theName)
  test <- http_status(GET(url))
  
  if (test$category == "client error")
    return()

  vcard <- read_html(url) %>%
    html_nodes(".vcard")
  
  if (length(vcard) == 0)
    return()
  
  vcardInfo <- vcard[[1]]
  
  HTML(as(vcardInfo,"character"))
})

 uiOutput("wikiCard")

```


Daily Top 10
=====================================


```{r}

topTenData <- reactive({
  
  # get rid of generic pages
  
  
  vcardImage <- vector(mode = "character", length = 10)

for(i in seq_along(todayTopTen$article)) {
  topName <- todayTopTen$article[i]
  url <- paste0("http://en.wikipedia.org/wiki/",topName)
  test <- http_status(GET(url))
  
  temp <- read_html(url) %>%
    html_nodes(".vcard img") %>% 
    html_attr("src")
  
  vcardImage[i]<- ifelse(length(temp!=0),temp,"http://www.premiersoccerstats.com/noImage2.jpg")
  
}
#   exclude <- c("Main_Page","404.php", "Special:Search")
#   
# todayTopTen <-pageViewsEn %>% 
#   filter(date==max(date)&!article %in% exclude) %>% 
#   select(article,views) %>% 
#   mutate(rank=min_rank(-views)) %>% 
#   head(10)
# 
# 
# topName <- todayTopTen$article[1]
# url <- paste0("http://en.wikipedia.org/wiki/",topName)
# test <- http_status(GET(url))
# 
# 
# 
# vcardImage <- read_html(url) %>%
#   html_nodes(".vcard img") %>% 
#   html_attr("src")



info=list(vcardImage=vcardImage)
return(info)

})

```

### 1


```{r}

output$one <- renderUI({
 
  list(img(src=topTenData()$vcardImage[1]))
})

uiOutput("one")

#broken image copy is 
# http://upload.wikimedia.org/wikipedia/commons/thumb/e/e0/Tom_Brady_2016.JPG/220px-Tom_Brady_2016.JPG

# output$one <- renderUI({
#   req(topTenData()) # this is working
#   print("b")
#  print(topTenData()$vcardImage)
#    print("b2") #"//upload.wikimedia.org/wikipedia/commons/thumb/e/e0/Tom_Brady_2016.JPG/220px-Tom_Brady_2016.JPG"
#   HTML(as(topTenData()$vcardImage,"character"))
# })
# 
#  uiOutput("one")

## from mediaHeadlines in GDELT
   
#    output$one <- renderUI({
#   
#    list(
# h4(strong(info()$data$titleArticle[1])),
#   a(href=info()$data$urlArticle[1], target='_blank', img(src=info()$data$urlThumbnail[1], width= 350))
#   )
# })
# 
# uiOutput("one")



```

### 2


```{r}

output$two <- renderUI({
 
  list(paste0(h4(strong(todayTopTen$article[2])),todayTopTen$views[2]," views"),
       img(src=topTenData()$vcardImage[2]))
  
  # list(h4(strong(todayTopTen$article[2])),
  #      paste0(todayTopTen$views[2]," views"),
  #   img(src=topTenData()$vcardImage[2]))
})

uiOutput("two")

```

### 3

```{r}

output$three <- renderUI({
 
  list(img(src=topTenData()$vcardImage[3]))
})

uiOutput("three")

```